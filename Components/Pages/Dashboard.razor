@page "/dashboard"
@layout PaneGEST_Blazor_MySQL.Components.Layout.EmptyLayout
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize]
<!-- ESTA LINHA ERA A QUE FALTAVA PARA OS BOTÕES FUNCIONAREM: -->
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>PaneGEST - Dashboard</PageTitle>

<div class="layout-container">

    <!-- 1. SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-logo">PaneGEST</div>
        <div class="spacer"></div>
        <button class="btn-sair" @onclick="Logout">
            🚪 SAIR
        </button>
    </div>

    <!-- 2. PAINEL DIREITO -->
    <div class="main-content">

        <!-- TOP BAR -->
        <div class="topbar">
            <div class="user-status">Bem-vindo, <strong>@userName</strong></div>
            <div class="date-display">@dataHoje</div>
        </div>

        <!-- CONTEÚDO -->
        <div class="content-area">
            <div class="cards-grid">

                <!-- Card 1: Utilizadores -->
                <div class="simple-card" style="--card-color: #6610F2" @onclick='() => NavigateTo("utilizadores")'>
                    <div class="card-stripe"></div>
                    <div class="card-body">
                        <div class="card-icon">👤</div>
                        <div class="card-title">Utilizadores</div>
                        <div class="card-desc">Gerir Utilizadores</div>
                    </div>
                </div>

                <!-- Card 2: Lojas -->
                <div class="simple-card" style="--card-color: #FD7E14" @onclick='() => NavigateTo("lojas")'>
                    <div class="card-stripe"></div>
                    <div class="card-body">
                        <div class="card-icon">🏠</div>
                        <div class="card-title">Lojas</div>
                        <div class="card-desc">Gerir Lojas</div>
                    </div>
                </div>

                <!-- Card 3: Movimentos -->
                <div class="simple-card" style="--card-color: #28A745" @onclick='() => NavigateTo("movimentos")'>
                    <div class="card-stripe"></div>
                    <div class="card-body">
                        <div class="card-icon">💲</div>
                        <div class="card-title">Movimentos</div>
                        <div class="card-desc">Movimentos de Caixa</div>
                    </div>
                </div>

                <!-- Card 4: Relatórios -->
                <div class="simple-card" style="--card-color: #DC3545" @onclick='() => NavigateTo("relatorios")'>
                    <div class="card-stripe"></div>
                    <div class="card-body">
                        <div class="card-icon">📊</div>
                        <div class="card-title">Relatórios</div>
                        <div class="card-desc">Exportar dados</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    .layout-container {
        display: flex;
        height: 100vh;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
    }

    .sidebar {
        width: 220px;
        background-color: #28374C;
        display: flex;
        flex-direction: column;
        color: white;
        flex-shrink: 0;
    }

    .sidebar-logo {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20pt;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .spacer {
        flex-grow: 1;
    }

    .btn-sair {
        height: 60px;
        background-color: #DC3545;
        color: white;
        border: none;
        font-size: 12pt;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
    }

        .btn-sair:hover {
            background-color: #c82333;
        }

    .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #F5F7FA;
    }

    .topbar {
        height: 60px;
        background-color: white;
        border-bottom: 1px solid lightgray;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        flex-shrink: 0;
    }

    .user-status {
        font-size: 12pt;
        color: gray;
    }

    .date-display {
        font-size: 12pt;
        font-weight: bold;
        color: #28374C;
    }

    .content-area {
        padding: 30px;
        overflow-y: auto;
        flex-grow: 1;
    }

    .cards-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .simple-card {
        width: 260px;
        height: 160px;
        background-color: white;
        border: 1px solid #ddd;
        display: flex;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

        .simple-card:hover {
            background-color: #F8F8FF;
            border-color: #aaa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

    .card-stripe {
        width: 6px;
        height: 100%;
        background-color: var(--card-color);
    }

    .card-body {
        flex-grow: 1;
        padding: 20px;
        position: relative;
    }

    .card-title {
        font-size: 14pt;
        font-weight: bold;
        color: #3C3C3C;
        margin-bottom: 5px;
    }

    .card-desc {
        font-size: 10pt;
        color: gray;
    }

    .card-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 32pt;
        opacity: 0.8;
    }
</style>

@code {
    private string userName = "Utilizador";
    private string dataHoje = DateTime.Now.ToString("dd 'de' MMMM, yyyy");

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name ?? "Administrador";
        }
    }

    private void NavigateTo(string page)
    {
        Nav.NavigateTo($"/{page}");
    }

    private void Logout()
    {
        // forceLoad: true é obrigatório para chamar o Controller e fazer o redirecionamento externo
        Nav.NavigateTo("/account/logout", forceLoad: true);
    }
}
