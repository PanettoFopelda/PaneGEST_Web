@page "/relatorios/balanco"
@layout PaneGEST_Blazor_MySQL.Components.Layout.EmptyLayout
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PaneGEST_Blazor_MySQL.Models
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using System.IO
@using ApexCharts
@inject WwwpanetPaneGestContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Balanço Financeiro por Loja</PageTitle>

<div class="page-container">

    <!-- TOPO: Filtros -->
    <div class="top-panel">
        <div class="filter-row">

            <div class="filter-item">
                <label>De:</label>
                <input type="date" class="form-control" @bind="dataInicio" />
            </div>

            <div class="filter-item">
                <label>Até:</label>
                <input type="date" class="form-control" @bind="dataFim" />
            </div>

            <div class="filter-item" style="flex-grow: 1; max-width: 300px;">
                <label>Loja:</label>
                <select class="form-control" @bind="lojaSelecionadaId">
                    <option value="0">--- TODAS ---</option>
                    @foreach (var l in ListaLojas)
                    {
                        <option value="@l.IdLoja">@l.NomeLoja</option>
                    }
                </select>
            </div>

            <button class="btn btn-primary" @onclick="Pesquisar">🔍 Calcular</button>

            <!-- Botão Gráfico -->
            <button class="btn btn-secondary ms-2" @onclick="() => mostrarGrafico = !mostrarGrafico">
                @(mostrarGrafico ? "🚫 Ocultar Gráfico" : "📊 Ver Gráfico")
            </button>

        </div>
    </div>

    <!-- ÁREA DO GRÁFICO (Colapsável) -->
    @if (mostrarGrafico && ListaBalanco.Count > 0)
    {
        <div class="chart-panel">
            <ApexChart TItem="BalancoItem"
                       Title="Comparativo Financeiro por Loja"
                       Height="350">

                <!-- Série Verde (ON) -->
                <ApexPointSeries TItem="BalancoItem"
                                 Items="ListaBalanco"
                                 Name="Total ON"
                                 SeriesType="SeriesType.Bar"
                                 XValue="@(e => e.NomeLoja)"
                                 YValue="@(e => e.TotalON)"
                                 Color="#198754" />

                <!-- Série Vermelha (OFF) -->
                <ApexPointSeries TItem="BalancoItem"
                                 Items="ListaBalanco"
                                 Name="Total OFF"
                                 SeriesType="SeriesType.Bar"
                                 XValue="@(e => e.NomeLoja)"
                                 YValue="@(e => e.TotalOFF)"
                                 Color="#dc3545" />
            </ApexChart>
        </div>
    }

    <!-- MEIO: Tabela -->
    <div class="grid-panel">
        <table class="custom-table">
            <thead>
                <tr>
                    <th style="width: 40%; cursor: pointer;" @onclick='() => Ordenar("loja")'>
                        Loja @(sortColumn == "loja" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 20%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("on")'>
                        Total ON @(sortColumn == "on" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 20%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("off")'>
                        Total OFF @(sortColumn == "off" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 20%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("global")'>
                        Total Global @(sortColumn == "global" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (ListaBalanco == null)
                {
                    <tr><td colspan="4" class="text-center p-3">A calcular...</td></tr>
                }
                else if (ListaBalanco.Count == 0)
                {
                    <tr><td colspan="4" class="text-center p-3 text-muted">Sem dados para este período/loja.</td></tr>
                }
                else
                {
                    @foreach (var item in ListaBalanco)
                    {
                        <tr>
                            <td style="font-weight: 500;">@item.NomeLoja</td>
                            <td class="valor-on">@item.TotalON.ToString("C2")</td>
                            <td class="valor-off">@item.TotalOFF.ToString("C2")</td>
                            <td class="valor-global">@item.TotalGlobal.ToString("C2")</td>
                        </tr>
                    }
                }
            </tbody>
            <!-- Rodapé da Tabela (Somatórios Gerais) -->
            <tfoot>
                <tr style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #ccc;">
                    <td style="text-align: right; padding-right: 20px;">TOTAIS GERAIS:</td>
                    <td style="text-align: right; color: #198754;">@GrandTotalON.ToString("C2")</td>
                    <td style="text-align: right; color: #dc3545;">@GrandTotalOFF.ToString("C2")</td>
                    <td style="text-align: right; color: #0d6efd; font-size: 1.1em;">@GrandTotalGlobal.ToString("C2")</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- RODAPÉ: Botões -->
    <div class="bottom-panel">
        <button class="btn btn-pdf" @onclick="GerarPDF">🖨️ Gerar PDF / Imprimir</button>
        <button class="btn btn-back" @onclick="Voltar">🔙 Voltar</button>
    </div>

</div>

<style>
    /* CSS Layout */
    .page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        font-family: 'Segoe UI', sans-serif;
        background-color: white;
    }

    .top-panel {
        padding: 15px 20px;
        background-color: white;
        border-bottom: 1px solid #ccc;
        flex-shrink: 0;
    }

    /* Painel Gráfico */
    .chart-panel {
        background-color: white;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0;
    }

    .filter-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
    }

    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

        .filter-item label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

    .form-control {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .grid-panel {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
    }

        .custom-table th {
            background-color: #4682B4;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
            user-select: none;
            font-size: 0.95rem;
        }

        .custom-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .custom-table tr:hover {
            background-color: #eef;
        }

    .valor-on {
        text-align: right;
        color: #198754;
    }

    .valor-off {
        text-align: right;
        color: #dc3545;
    }

    .valor-global {
        text-align: right;
        color: #000080;
        font-weight: bold;
    }

    .bottom-panel {
        padding: 15px 20px;
        background-color: #D3D3D3;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #aaa;
        flex-shrink: 0;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        color: white;
    }

    .btn-primary {
        background-color: #0d6efd;
        height: 38px;
        min-width: 120px;
    }

    .btn-secondary {
        background-color: #6c757d;
        height: 38px;
    }

    .btn-pdf {
        background-color: #198754;
    }

    .btn-back {
        background-color: #CD5C5C;
    }

    .btn:hover {
        opacity: 0.9;
    }
</style>

@code {
    // --- VIEW MODEL ---
    public class BalancoItem
    {
        public string NomeLoja { get; set; } = "";
        public decimal TotalON { get; set; }
        public decimal TotalOFF { get; set; }
        public decimal TotalGlobal => TotalON + TotalOFF;
    }

    // --- ESTADO ---
    private List<Loja> ListaLojas = new();
    private List<BalancoItem> ListaBalanco = new();

    private DateTime dataInicio;
    private DateTime dataFim;
    private int lojaSelecionadaId = 0;

    private bool mostrarGrafico = false;
    private string sortColumn = "global";
    private bool isAscending = false;

    // --- TOTAIS GERAIS ---
    private decimal GrandTotalON => ListaBalanco.Sum(i => i.TotalON);
    private decimal GrandTotalOFF => ListaBalanco.Sum(i => i.TotalOFF);
    private decimal GrandTotalGlobal => ListaBalanco.Sum(i => i.TotalGlobal);

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        dataInicio = new DateTime(DateTime.Now.Year, 1, 1);
        dataFim = DateTime.Now;

        ListaLojas = await Db.Lojas.OrderBy(l => l.NomeLoja).ToListAsync();

        await Pesquisar();
    }

    private async Task Pesquisar()
    {
        DateOnly dInicio = DateOnly.FromDateTime(dataInicio);
        DateOnly dFim = DateOnly.FromDateTime(dataFim);

        var query = from m in Db.Movimentos
                    join l in Db.Lojas on m.IdLoja equals l.IdLoja
                    where m.DataMovimento >= dInicio && m.DataMovimento <= dFim
                    && (lojaSelecionadaId == 0 || m.IdLoja == lojaSelecionadaId)

                    group m by new { l.IdLoja, l.NomeLoja } into g
                    select new BalancoItem
                    {
                        NomeLoja = g.Key.NomeLoja,
                        TotalON = (decimal)g.Sum(x => x.ValorOn),
                        TotalOFF = (decimal)g.Sum(x => x.ValorOff)
                    };

        ListaBalanco = await query.ToListAsync();
        AplicarOrdenacao();
    }

    private void Ordenar(string col)
    {
        if (sortColumn == col) isAscending = !isAscending;
        else { sortColumn = col; isAscending = true; }

        if (col != sortColumn && (col == "global" || col == "on" || col == "off")) isAscending = false;

        AplicarOrdenacao();
    }

    private void AplicarOrdenacao()
    {
        // Nota: O gráfico usa "ListaBalanco" diretamente, por isso
        // ao ordenarmos a lista aqui, o gráfico também se reordena visualmente.
        switch (sortColumn)
        {
            case "loja":
                ListaBalanco = isAscending
                    ? ListaBalanco.OrderBy(x => x.NomeLoja).ToList()
                    : ListaBalanco.OrderByDescending(x => x.NomeLoja).ToList();
                break;
            case "on":
                ListaBalanco = isAscending
                    ? ListaBalanco.OrderBy(x => x.TotalON).ToList()
                    : ListaBalanco.OrderByDescending(x => x.TotalON).ToList();
                break;
            case "off":
                ListaBalanco = isAscending
                    ? ListaBalanco.OrderBy(x => x.TotalOFF).ToList()
                    : ListaBalanco.OrderByDescending(x => x.TotalOFF).ToList();
                break;
            case "global":
                ListaBalanco = isAscending
                    ? ListaBalanco.OrderBy(x => x.TotalGlobal).ToList()
                    : ListaBalanco.OrderByDescending(x => x.TotalGlobal).ToList();
                break;
        }
    }

    private void Voltar() => Nav.NavigateTo("/relatorios");

    // =================================================================
    // PDF GENERATION
    // =================================================================
    private async Task GerarPDF()
    {
        if (ListaBalanco.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "Sem dados para gerar PDF.");
            return;
        }

        string nomeLojaHeader = lojaSelecionadaId == 0
            ? "TODAS"
            : ListaLojas.FirstOrDefault(l => l.IdLoja == lojaSelecionadaId)?.NomeLoja ?? "";

        var documento = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4.Portrait());
                page.Margin(1, Unit.Centimetre);
                page.PageColor(Colors.White);
                page.DefaultTextStyle(x => x.FontSize(10).FontFamily("Segoe UI"));

                page.Header().Row(row =>
                {
                    row.RelativeItem().Column(col =>
                    {
                        col.Item().Text("Balanço Financeiro por Loja").FontSize(16).SemiBold().FontColor(Colors.Blue.Darken2);
                        col.Item().Text($"Período: {dataInicio:dd/MM/yyyy} até {dataFim:dd/MM/yyyy}").FontSize(11);
                        col.Item().Text($"Filtro: {nomeLojaHeader}").FontSize(10);
                    });
                    row.ConstantItem(100).AlignRight().Text(DateTime.Now.ToString("dd/MM/yyyy")).FontSize(9).FontColor(Colors.Grey.Medium);
                });

                page.Content().PaddingVertical(10).Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.RelativeColumn(2f);
                        columns.RelativeColumn(1f);
                        columns.RelativeColumn(1f);
                        columns.RelativeColumn(1f);
                    });

                    table.Header(header =>
                    {
                        void HeaderCell(IContainer c, string t) =>
                            c.Background(Colors.Grey.Darken3).Padding(5).AlignCenter().Text(t).FontColor(Colors.White).Bold();

                        header.Cell().Element(c => HeaderCell(c, "Loja"));
                        header.Cell().Element(c => HeaderCell(c, "Total ON"));
                        header.Cell().Element(c => HeaderCell(c, "Total OFF"));
                        header.Cell().Element(c => HeaderCell(c, "Total Global"));
                    });

                    for (int i = 0; i < ListaBalanco.Count; i++)
                    {
                        var item = ListaBalanco[i];
                        var bgCor = (i % 2 == 0) ? Colors.White : Colors.Grey.Lighten4;

                        IContainer CellStyle(IContainer c) => c.Background(bgCor).BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(5);

                        table.Cell().Element(CellStyle).AlignLeft().Text(item.NomeLoja).Medium();
                        table.Cell().Element(CellStyle).AlignRight().Text(item.TotalON.ToString("C2")).FontColor(Colors.Green.Darken2);
                        table.Cell().Element(CellStyle).AlignRight().Text(item.TotalOFF.ToString("C2")).FontColor(Colors.Red.Medium);
                        table.Cell().Element(CellStyle).AlignRight().Text(item.TotalGlobal.ToString("C2")).FontColor(Colors.Blue.Darken3).Bold();
                    }

                    table.Footer(footer =>
                    {
                        IContainer FooterStyle(IContainer c) => c.Background(Colors.Grey.Lighten2).BorderTop(1).Padding(5);

                        footer.Cell().Element(FooterStyle).Text("TOTAIS GERAIS").Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(GrandTotalON.ToString("C2")).Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(GrandTotalOFF.ToString("C2")).Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(GrandTotalGlobal.ToString("C2")).Bold().FontSize(11);
                    });
                });

                page.Footer().AlignCenter().Text(txt =>
                {
                    txt.Span("Página "); txt.CurrentPageNumber(); txt.Span(" de "); txt.TotalPages();
                });
            });
        });

        var pdfBytes = documento.GeneratePdf();
        using var stream = new MemoryStream(pdfBytes);
        using var streamRef = new DotNetStreamReference(stream);
        await JS.InvokeVoidAsync("openPdfInNewTab", streamRef);
    }
}