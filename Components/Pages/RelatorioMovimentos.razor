@page "/relatorios/movimentos"
@layout PaneGEST_Blazor_MySQL.Components.Layout.EmptyLayout
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PaneGEST_Blazor_MySQL.Models
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using System.IO
@using ApexCharts
@inject WwwpanetPaneGestContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Relatório de Movimentos</PageTitle>

<div class="page-container">

    <!-- TOPO: Filtros -->
    <div class="top-panel">
        <div class="filter-row">
            <div class="filter-item">
                <label>De:</label>
                <input type="date" class="form-control" @bind="dataInicio" />
            </div>
            <div class="filter-item">
                <label>Até:</label>
                <input type="date" class="form-control" @bind="dataFim" />
            </div>
            <div class="filter-item" style="flex-grow: 1; max-width: 300px;">
                <label>Loja:</label>
                <select class="form-control" @bind="lojaSelecionadaId">
                    <option value="0">--- TODAS ---</option>
                    @foreach (var l in ListaLojas)
                    {
                        <option value="@l.IdLoja">@l.NomeLoja</option>
                    }
                </select>
            </div>
            <button class="btn btn-primary" @onclick="Pesquisar">🔍 Pesquisar</button>

            <!-- Botão para Alternar Gráfico -->
            <button class="btn btn-secondary ms-2" @onclick="() => mostrarGrafico = !mostrarGrafico">
                @(mostrarGrafico ? "🚫 Ocultar Gráfico" : "📊 Ver Gráfico")
            </button>
        </div>
    </div>

    <!-- ÁREA DO GRÁFICO (Colapsável) -->
    @if (mostrarGrafico && ListaGrafico.Count > 0)
    {
        <div class="chart-panel">
            <ApexChart TItem="GraficoItem"
                       Title="Evolução Diária (ON vs OFF)"
                       Height="300">

                <!-- Série Verde (ON) -->
                <ApexPointSeries TItem="GraficoItem"
                                 Items="ListaGrafico"
                                 Name="Valor ON"
                                 SeriesType="SeriesType.Area"
                                 XValue="@(e => e.Data)"
                                 YValue="@(e => e.TotalON)"
                                 Color="#198754" />

                <!-- Série Vermelha (OFF) -->
                <ApexPointSeries TItem="GraficoItem"
                                 Items="ListaGrafico"
                                 Name="Valor OFF"
                                 SeriesType="SeriesType.Area"
                                 XValue="@(e => e.Data)"
                                 YValue="@(e => e.TotalOFF)"
                                 Color="#dc3545" />
            </ApexChart>
        </div>
    }

    <!-- MEIO: Tabela -->
    <div class="grid-panel">
        <table class="custom-table">
            <thead>
                <tr>
                    <th style="width: 20%; cursor: pointer;" @onclick='() => Ordenar("loja")'>
                        Loja @(sortColumn == "loja" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 15%; text-align: center; cursor: pointer;" @onclick='() => Ordenar("data")'>
                        Data @(sortColumn == "data" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 25%; cursor: pointer;" @onclick='() => Ordenar("obs")'>
                        Observações @(sortColumn == "obs" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 13%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("on")'>
                        Valor ON @(sortColumn == "on" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 13%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("off")'>
                        Valor OFF @(sortColumn == "off" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                    <th style="width: 14%; text-align: right; cursor: pointer;" @onclick='() => Ordenar("total")'>
                        Total @(sortColumn == "total" ? (isAscending ? "▲" : "▼") : "")
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (ListaMovimentos == null)
                {
                    <tr><td colspan="6" class="text-center p-3">A carregar...</td></tr>
                }
                else if (ListaMovimentos.Count == 0)
                {
                    <tr><td colspan="6" class="text-center p-3 text-muted">Sem movimentos neste período.</td></tr>
                }
                else
                {
                    @foreach (var m in ListaMovimentos)
                    {
                        <tr>
                            <td style="font-weight: 500;">@m.NomeLoja</td>
                            <td style="text-align: center;">@m.Data.ToString("dd-MM-yyyy")</td>
                            <td style="color: #555; font-size: 0.9em;">@m.Obs</td>
                            <td class="valor-on">@m.ValorON.ToString("C2")</td>
                            <td class="valor-off">@m.ValorOFF.ToString("C2")</td>
                            <td class="valor-total">@m.Total.ToString("C2")</td>
                        </tr>
                    }
                }
            </tbody>
            <tfoot>
                <tr style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #ccc;">
                    <td colspan="3" style="text-align: right; padding-right: 20px;">TOTAIS GERAIS:</td>
                    <td style="text-align: right; color: #198754;">@TotalON.ToString("C2")</td>
                    <td style="text-align: right; color: #dc3545;">@TotalOFF.ToString("C2")</td>
                    <td style="text-align: right; color: #0d6efd;">@TotalGeral.ToString("C2")</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- RODAPÉ: Botões -->
    <div class="bottom-panel">
        <button class="btn btn-pdf" @onclick="GerarPDF">🖨️ Gerar PDF / Imprimir</button>
        <button class="btn btn-back" @onclick="Voltar">🔙 Voltar</button>
    </div>

</div>

<style>
    /* Layout */
    .page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        font-family: 'Segoe UI', sans-serif;
        background-color: white;
    }

    .top-panel {
        padding: 15px 20px;
        background-color: white;
        border-bottom: 1px solid #ccc;
        flex-shrink: 0;
    }

    /* Painel do Gráfico */
    .chart-panel {
        background-color: white;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0;
    }

    .filter-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
    }

    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

        .filter-item label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

    .form-control {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Grid */
    .grid-panel {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
    }

        .custom-table th {
            background-color: #4682B4;
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
            user-select: none;
            font-size: 0.95rem;
        }

        .custom-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .custom-table tr:hover {
            background-color: #eef;
        }

    .valor-on {
        text-align: right;
        color: #198754;
    }

    .valor-off {
        text-align: right;
        color: #dc3545;
    }

    .valor-total {
        text-align: right;
        color: #0d6efd;
        font-weight: bold;
    }

    .bottom-panel {
        padding: 15px 20px;
        background-color: #D3D3D3;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #aaa;
        flex-shrink: 0;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        color: white;
    }

    .btn-primary {
        background-color: #0d6efd;
        height: 38px;
    }

    .btn-secondary {
        background-color: #6c757d;
        height: 38px;
    }

    .btn-pdf {
        background-color: #198754;
    }

    .btn-back {
        background-color: #CD5C5C;
    }

    .btn:hover {
        opacity: 0.9;
    }
</style>

@code {
    // --- MODELS ---
    public class MovimentoRelatorioItem
    {
        public string NomeLoja { get; set; } = "";
        public DateTime Data { get; set; }
        public string Obs { get; set; } = "";
        public decimal ValorON { get; set; }
        public decimal ValorOFF { get; set; }
        public decimal Total => ValorON + ValorOFF;
    }

    // Modelo Agrupado para o Gráfico (Soma por dia)
    public class GraficoItem
    {
        public DateTime Data { get; set; }
        public decimal TotalON { get; set; }
        public decimal TotalOFF { get; set; }
    }

    // --- ESTADO ---
    private List<Loja> ListaLojas = new();
    private List<MovimentoRelatorioItem> ListaMovimentos = new();
    private List<GraficoItem> ListaGrafico = new(); // Dados para o gráfico

    private DateTime dataInicio;
    private DateTime dataFim;
    private int lojaSelecionadaId = 0;
    private bool mostrarGrafico = false; // Controlo de visibilidade

    // Ordenação
    private string sortColumn = "data";
    private bool isAscending = false;

    // Totais
    private decimal TotalON => ListaMovimentos.Sum(m => m.ValorON);
    private decimal TotalOFF => ListaMovimentos.Sum(m => m.ValorOFF);
    private decimal TotalGeral => ListaMovimentos.Sum(m => m.Total);

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        dataInicio = new DateTime(DateTime.Now.Year, 1, 1);
        dataFim = DateTime.Now;

        ListaLojas = await Db.Lojas.OrderBy(l => l.NomeLoja).ToListAsync();
        await Pesquisar();
    }

    private async Task Pesquisar()
    {
        DateOnly dInicio = DateOnly.FromDateTime(dataInicio);
        DateOnly dFim = DateOnly.FromDateTime(dataFim);

        var query = from m in Db.Movimentos
                    join l in Db.Lojas on m.IdLoja equals l.IdLoja
                    where m.DataMovimento >= dInicio && m.DataMovimento <= dFim
                    select new { Movimento = m, NomeLoja = l.NomeLoja };

        if (lojaSelecionadaId > 0)
        {
            query = query.Where(x => x.Movimento.IdLoja == lojaSelecionadaId);
        }

        var dadosRaw = await query.ToListAsync();

        // 1. Preencher Lista da Tabela
        ListaMovimentos = dadosRaw.Select(x => new MovimentoRelatorioItem
        {
            NomeLoja = x.NomeLoja,
            Data = x.Movimento.DataMovimento.ToDateTime(TimeOnly.MinValue),
            Obs = x.Movimento.Observacoes ?? "",
            ValorON = (decimal)x.Movimento.ValorOn,
            ValorOFF = (decimal)x.Movimento.ValorOff
        }).ToList();

        // 2. Preencher Lista do Gráfico (Agrupar por Dia)
        // Se houver 50 movimentos num dia, o gráfico mostra 1 ponto com o total desse dia.
        ListaGrafico = ListaMovimentos
            .GroupBy(m => m.Data.Date)
            .Select(g => new GraficoItem
            {
                Data = g.Key,
                TotalON = g.Sum(x => x.ValorON),
                TotalOFF = g.Sum(x => x.ValorOFF)
            })
            .OrderBy(g => g.Data)
            .ToList();

        // Aplicar ordenação inicial na tabela
        AplicarOrdenacao();
    }

    private void Ordenar(string col)
    {
        if (sortColumn == col) isAscending = !isAscending;
        else { sortColumn = col; isAscending = true; }
        AplicarOrdenacao();
    }

    private void AplicarOrdenacao()
    {
        switch (sortColumn)
        {
            case "loja": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.NomeLoja).ToList() : ListaMovimentos.OrderByDescending(m => m.NomeLoja).ToList(); break;
            case "data": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.Data).ToList() : ListaMovimentos.OrderByDescending(m => m.Data).ToList(); break;
            case "obs": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.Obs).ToList() : ListaMovimentos.OrderByDescending(m => m.Obs).ToList(); break;
            case "on": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.ValorON).ToList() : ListaMovimentos.OrderByDescending(m => m.ValorON).ToList(); break;
            case "off": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.ValorOFF).ToList() : ListaMovimentos.OrderByDescending(m => m.ValorOFF).ToList(); break;
            case "total": ListaMovimentos = isAscending ? ListaMovimentos.OrderBy(m => m.Total).ToList() : ListaMovimentos.OrderByDescending(m => m.Total).ToList(); break;
        }
    }

    private void Voltar() => Nav.NavigateTo("/relatorios");

    // =================================================================
    // PDF GENERATION
    // =================================================================
    private async Task GerarPDF()
    {
        if (ListaMovimentos.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "Não existem dados para gerar o PDF.");
            return;
        }

        string nomeLojaHeader = lojaSelecionadaId == 0
            ? "TODAS"
            : ListaLojas.FirstOrDefault(l => l.IdLoja == lojaSelecionadaId)?.NomeLoja ?? "Desconhecida";

        var documento = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4.Portrait());
                page.Margin(1, Unit.Centimetre);
                page.PageColor(Colors.White);
                page.DefaultTextStyle(x => x.FontSize(9).FontFamily("Segoe UI"));

                page.Header().Row(row =>
                {
                    row.RelativeItem().Column(col =>
                    {
                        col.Item().Text("Relatório Detalhado de Movimentos").FontSize(16).SemiBold().FontColor(Colors.Blue.Darken2);
                        col.Item().Text($"Período: {dataInicio:dd/MM/yyyy} até {dataFim:dd/MM/yyyy}");
                        col.Item().Text($"Loja: {nomeLojaHeader}");
                    });
                    row.ConstantItem(150).AlignRight().Text(DateTime.Now.ToString("dd/MM/yyyy HH:mm")).FontSize(9).FontColor(Colors.Grey.Medium);
                });

                page.Content().PaddingVertical(10).Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.RelativeColumn(1.5f);
                        columns.RelativeColumn(1f);
                        columns.RelativeColumn(2f);
                        columns.RelativeColumn(1f);
                        columns.RelativeColumn(1f);
                        columns.RelativeColumn(1f);
                    });

                    table.Header(header =>
                    {
                        void HeaderCell(IContainer container, string text) =>
                            container.Background(Colors.Grey.Darken3).Padding(5).AlignCenter().Text(text).FontColor(Colors.White).Bold();

                        header.Cell().Element(c => HeaderCell(c, "Loja"));
                        header.Cell().Element(c => HeaderCell(c, "Data"));
                        header.Cell().Element(c => HeaderCell(c, "Observações"));
                        header.Cell().Element(c => HeaderCell(c, "Valor ON"));
                        header.Cell().Element(c => HeaderCell(c, "Valor OFF"));
                        header.Cell().Element(c => HeaderCell(c, "Total"));
                    });

                    for (int i = 0; i < ListaMovimentos.Count; i++)
                    {
                        var item = ListaMovimentos[i];
                        var bgCor = (i % 2 == 0) ? Colors.White : Colors.Grey.Lighten4;

                        IContainer CellStyle(IContainer c) => c.Background(bgCor).BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(5);

                        table.Cell().Element(CellStyle).AlignLeft().Text(item.NomeLoja);
                        table.Cell().Element(CellStyle).AlignCenter().Text(item.Data.ToString("dd-MM-yyyy"));
                        table.Cell().Element(CellStyle).AlignLeft().Text(item.Obs).FontSize(8);

                        table.Cell().Element(CellStyle).AlignRight().Text(item.ValorON.ToString("C2")).FontColor(Colors.Green.Darken2);
                        table.Cell().Element(CellStyle).AlignRight().Text(item.ValorOFF.ToString("C2")).FontColor(Colors.Red.Medium);
                        table.Cell().Element(CellStyle).AlignRight().Text(item.Total.ToString("C2")).FontColor(Colors.Blue.Darken2).Bold();
                    }

                    table.Footer(footer =>
                    {
                        IContainer FooterStyle(IContainer c) => c.Background(Colors.Grey.Lighten2).BorderTop(1).Padding(5);

                        footer.Cell().ColumnSpan(3).Element(FooterStyle).AlignRight().Text("TOTAIS:").Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(TotalON.ToString("C2")).Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(TotalOFF.ToString("C2")).Bold();
                        footer.Cell().Element(FooterStyle).AlignRight().Text(TotalGeral.ToString("C2")).Bold();
                    });
                });

                page.Footer().AlignCenter().Text(txt =>
                {
                    txt.Span("Página "); txt.CurrentPageNumber(); txt.Span(" de "); txt.TotalPages();
                });
            });
        });

        var pdfBytes = documento.GeneratePdf();
        using var stream = new MemoryStream(pdfBytes);
        using var streamRef = new DotNetStreamReference(stream);
        await JS.InvokeVoidAsync("openPdfInNewTab", streamRef);
    }
}